hrs=window.hrs||{};hrs.ui=window.hrs.ui||{};utils=new Utils;hrs.ui.main=function(e,t,n){function l(){var r=n.loadSettings();if(r.permAhgora==1){var i=r.matricula;var s=r.senha;var o=r.empresa;if(o.length==0){o=null}if(s.length==0){s=null}if(i.length==0){i=null}if(i==null||s==null||o==null){var a="Informe sua Matrícula, Senha e Empresa nas Configurações antes de realizar a importação.";e("#msg-lightbox-content").html(a);L("#perform-update");C("#msg-lightbox")}else{u=new Ahgora(i,s,o,t,n,C,L,S,m)}}else{u=null}}function c(){s=new hrs.ui.month(i.getMonth(),i.getFullYear());var e=i.getMonth();var t=i.getFullYear();u.import(e,t,null)}function h(){alert("Clicou na parada e tal...")}function p(){o=new DesktopNotifications}function d(){}function v(){var e=new Date;var t=e.getFullYear();var n=e.getDay();var r=e.getDate();var i=e.getMonth();var o=new Date(t,i,r);var a=s.getRowInfo(o);var f=a.entrada;var l=e.getHours();var c=e.getMinutes();var h=e.getSeconds();if(parseInt(c)==59&&parseInt(h)==0){u.import(i,t,r)}var p=setTimeout(function(){v()},500)}function m(){v();var t=hrs.helpers.dateTime;var n=new Date;var r=n.getMonth();var i=n.getFullYear();var o=n.getDate();var u=new Date(i,r,o);var a=s.getRowInfo(u);var f=a.expectedExit;var l=f.substring(0,2);var c=f.substring(3,5);var h=new Date(i,r,o,l,c,0,0);var p=a.almoco;var d=a.ida_almoco;var m=a.volta_almoco;var g=a.volta_almoco_estimada;var y=a.volta_almoco_estimada_time;var t=hrs.helpers.dateTime;e("#saidaAlmocoEstimada").html("12:00");var E;if(d.length>0){E=d}else{E="-"}e("#saidaAlmocoReal").html(E);var S;if(g.length>0){S=g}else{S="-"}e("#retornoAlmoco").html(S);e("#retornoAlmocoReal").html("-");if((m==null||m=="undefined"||m=="")&&d.length>0){var x=new Date(y.getYear(),y.getMonth(),y.getDay(),y.getHours(),y.getMinutes(),0,0);e("#retornoAlmoco").html(S);e("#retornoAlmocoTimer").css("color","green");e("#retornoAlmocoReal").html("-");var T=t.getTimeDiff(y,n);var N=T.getTime();b(y,N)}else{e("#retornoAlmocoTimer").css("color","black");e("#retornoAlmocoReal").html(m);e("#retornoAlmocoTimer").html("-");e("#retornoAlmoco").html("-")}var C=a.saida;var k=a.entrada;if((C==null||C=="undefined"||C=="")&&k.length>0){e("#proxSaidaExtimada").html(f);e("#proxSaidaTimer").css("color","red");var L=t.getTimeDiff(h,n);var A=L.getTime();w(h,A)}else{e("#proxSaidaTimer").css("color","black");e("#saidaTimeLabel").html("Tempo até saída: ");e("#proxSaidaExtimada").html("-");e("#proxSaidaTimer").html("-")}}function g(e){var t=utils.checkbrowser();if(t.name=="Chrome"||t.name=="Firefox"){var n="Controle de Banco de Horas";var r={body:"Faltam "+e+" minuto(s) para sua saída. Fique atento!",icon:"res/icon.png"};o.create(n,r,null)}else{alert("Notificações não implementadas para esta versão do seu browser.")}}function y(e,t){var n=utils.checkbrowser();if(n.name=="Chrome"||n.name=="Firefox"){var r="Controle de Banco de Horas";var i={body:e,icon:"res/icon.png"};o.create(r,i,null,t)}else{alert("Notificações não implementadas para esta versão do seu browser.")}}function b(t,n){var r=new Date;var i=hrs.helpers.dateTime;if(n>0){e("#retornoAlmocoTimer").css("color","green");e("#retornoAlmocoTimerLabel").html("Tempo até retorno: ");var s=i.getTimeDiff(t,r);n=s.getTime()}else{e("#retornoAlmocoTimer").css("color","red");e("#retornoAlmocoTimerLabel").html("Tempo de atraso: ");var s=i.getTimeDiff(r,t)}var o=s.getTime();var u=new Date(o);var a=s.getHours();var f=u.getMinutes();var l=u.getSeconds();if(n>0&&parseInt(a)==0){switch(f){case 5:if(l==59){var c="Faltam "+f+" minuto(s) para encerrar seu horário de almoço! Fique atento.";y(c,"five")}break;case 0:if(l==59){var c="Falta menos de um minuto minuto(s) para encerrar seu horário de almoço!";y(c,"default")}else if(l==0){var c="Seu horário de almoço já encerrou! Você deve bater seu ponto imediatamente!!!";y(c,"default")}break}}else if(n<0&&parseInt(a)==0){if(f>0&&l==0){var c="Seu horário de almoço já encerrou! Você deve bater seu ponto imediatamente!!!";y(c,"default")}}a=E(a);f=E(f);l=E(l);var h=a+":"+f+":"+l;e("#retornoAlmocoTimer").html(h);var p=setTimeout(function(){b(t,n)},500)}function w(t,n){var r=new Date;var i=hrs.helpers.dateTime;if(n>0){e("#saidaTimeLabel").html("Tempo até saída: ");e("#proxSaidaTimer").css("color","red");var s=i.getTimeDiff(t,r);n=s.getTime()}else{e("#saidaTimeLabel").html("Hora extra: ");e("#proxSaidaTimer").css("color","green");var s=i.getTimeDiff(r,t)}var o=s.getTime();var u=new Date(o);var a=s.getHours();var f=u.getMinutes();var l=u.getSeconds();if(n>0&&parseInt(a)==0){switch(f){case 30:if(l==59){var c="Faltam "+f+" minuto(s) para sua saída. Fique atento!";y(c,"default")}break;case 20:if(l==59){var c="Faltam "+f+" minuto(s) para sua saída. Fique atento!";y(c,"default")}break;case 10:if(l==59){var c="Faltam "+f+" minuto(s) para sua saída. Fique atento!";y(c,"ten")}break;case 5:if(l==59){if(f==5){var c="Faltam "+f+" minuto(s) para sua saída. Fique atento!";y(c,"five")}else{var c="Faltam "+f+" minuto(s) para sua saída. Fique atento!";y(c,"chimes")}}break;case 0:if(l==59){var c="Falta menos de 1 minuto para sua saída. Fique atento!";y(c,"default")}break}}a=E(a);f=E(f);l=E(l);var h=a+":"+f+":"+l;e("#proxSaidaTimer").html(h);var p=setTimeout(function(){w(t,n)},500)}function E(e){if(e<10){e="0"+e}return e}function S(){s=new hrs.ui.month(i.getMonth(),i.getFullYear());s.setDao(n);s.setUpdatedRowCallback(x);s.print(a);e("#main-table tr").each(function(){var t=e(this);T(t.find(".total, .excedente"),t.find(".excedente").html())});x()}function x(r,s){var o=n.calculateTotals(i.getMonth(),i.getFullYear());e("#extra").html(o.extra.toString());e("#extra-month").html(o.extraMonth.toString());e("#month-name").html(t.dateTime.formatDate(i,"#MM / #yyyy"));var u=t.dateTime.formatDate(i,"#MM / #yyyy");var a="Importar "+u+" (Sistema Ahgora)";e("#importMonth").attr("value",a);T(e("#extra"),o.extra.toString());T(e("#extra-month"),o.extraMonth.toString());if(s!=undefined){T(r.find(".total, .excedente"),s.excedente)}e("#entrance-avg").html(t.dateTime.formatDate(o.avgEntrance,"#hh#m"));e("#exit-avg").html(t.dateTime.formatDate(o.avgExit,"#hh#m"));if(o.totalExtraDays>=0){e("#positive-days").show().find("#days-off").html(o.totalExtraDays);e("#negative-days").hide()}else{e("#negative-days").show().find("#days-to-pay").html(o.totalExtraDays);e("#positive-days").hide()}e("#ausent-days").html(o.ausentDays)}function T(e,t){var n=typeof t=="string"?t.indexOf("-")>-1:t<0;var r=n?"addClass":"removeClass";e[r]("negative-hours")}function N(){var t=n.loadSettings();e("#total-work").val(t.totalWork).change(A);e("#lunch-time").val(t.lunchTime).change(A);e("#control-since").val(t.controlSince).change(A);e("#initial-balance").val(t.initialBalance).change(A);if(t.permAhgora==1){e("#permAhgora").attr("checked","checked");e("#showAhgora").fadeIn();e(".btImportMonth").show();e(".upDayOn").show();e(".upDayOff").hide()}else{e("#permAhgora").removeAttr("checked");e("#showAhgora").fadeOut();e(".btImportMonth").hide();e(".upDayOn").hide();e(".upDayOff").show()}e("#permAhgora").change(A);if(t.permNotif==1){e("#permNotif").attr("checked","checked");e("#showNotif").fadeIn()}else{e("#permNotif").removeAttr("checked");e("#showNotif").fadeOut()}e("#permNotif").change(A);e("#matricula").val(t.matricula).change(A);e("#senha").val(t.senha).change(A);e("#empresa").val(t.empresa).change(A);var r=e("div.utilDays input:checkbox");for(var i=0;i<t.utilDays.length;i++){r.filter("[value="+t.utilDays[i]+"]").attr("checked","checked")}r.change(A)}function C(t){var n=e(t);n.fadeIn().css("z-index",f++);var r=(e(window).width()-n.width())/2,i=(e(window).height()-n.height())/2;n.css({top:i+"px",left:r+"px"})}function k(){e(".open-lightbox").click(function(t){t.preventDefault();C(e(this).attr("href"))});e(".lightbox .close").click(function(t){e(this).closest(".lightbox").fadeOut().css("z-index","auto")})}function L(t){e(t).closest(".lightbox").fadeOut().css("z-index","auto")}function A(t,r){var i=[];e("input.utilDay:checked").each(function(){i.push(this.value)});var s=e("#permAhgora").is(":checked");s=s?1:0;var o=e("#permNotif").is(":checked");o=o?1:0;var u=e("#control-since").val();n.saveSettings({totalWork:e("#total-work").val(),lunchTime:e("#lunch-time").val(),controlSince:u,initialBalance:e("#initial-balance").val(),permAhgora:s,permNotif:o,matricula:e("#matricula").val(),senha:e("#senha").val(),empresa:e("#empresa").val(),holidays:r||hrs.ui.holidays.getHolidays(),utilDays:i});S()}function O(){e("#prev-month").click(function(){i.setMonth(i.getMonth()-1);S()});e("#next-month").click(function(){i.setMonth(i.getMonth()+1);S()})}function M(e){var t=new FileReader;t.onload=function(e){var t=e.target.result;n.importData(t);S()};t.readAsText(e,"UTF-8");setTimeout(function(){location.reload()},500)}function _(){e("#link-export").click(function(){e("#output-export").val(n.exportData())[0].select()});e("#output-export").click(function(){this.select()});e("#import-data").click(function(t){e("#inputfile-import-data").click()});e("#proced-import").click(function(){M(e("#confirm-import")[0].file)});e("#inputfile-import-data").change(function(t){var n=t.target.files;if(n.length==0)return;e("#confirm-import")[0].file=n[0];e("#inputfile-import-data").val("");C("#confirm-import")})}function D(){hrs.ui.holidays.init({$elem:e("#holidays-list"),holidays:n.getHolidays(),callback:function(e){A(null,e)}})}function P(){e("a.export-pdf").click(function(e){e.preventDefault();window.print()})}var r={};var i=null,s=null,o=null,u=null,a=null,f=3;r.init=function(t){a=t;i=new Date;S();N();k();O();_();D();p();P();m();v();l();e("#importMonth").click(function(){c()});e("#about-button").click(function(e){C("#about-lightbox")});e("#current-month").click(function(){var e=new Date;i.setMonth(e.getMonth());S()});e("#revisarPermissoes").click(function(){o.checkPermissionDirect()});e("#closeSettings").click(function(){window.location.reload()});e("#permAhgora").click(function(){var t=e(this).is(":checked");if(t){e("#showAhgora").fadeIn()}else{e("#showAhgora").fadeOut()}l()});e("#permNotif").click(function(){var t=e(this).is(":checked");if(t){e("#showNotif").fadeIn()}else{e("#showNotif").fadeOut()}})};window.updateDay=function(e){var t=i.getFullYear();var n=e+"/"+t;var r=n.substr(0,2);var s=n.substr(3,2);var o=e.substr(3,2);s=parseInt(o);if(parseInt(r)<11){s=parseInt(o)-1}else{s=parseInt(o)}u.import(s,t,r)};return r}(jQuery,hrs.helpers,hrs.dao);$(function(){hrs.ui.main.init($("#main-table"));$("#control-since").datepicker({dateFormat:"dd/mm/yy"})})